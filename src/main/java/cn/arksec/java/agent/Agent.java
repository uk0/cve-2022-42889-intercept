package cn.arksec.java.agent;

import cn.arksec.java.agent.hooks.Cve202242889;

import java.lang.instrument.Instrumentation;

import java.util.HashMap;

/**
 * @auther firsh.me
 * @2022-10-210
 */
@SuppressWarnings("unused")
public class Agent {

    public static void load(String _args, Instrumentation inst) {
        System.out.println("-----------------------load......");
        boolean deep_match = true;

        try {
            HashMap<String, String> args = new HashMap<String, String>();
            if (_args != null && !"".equals(_args)) {
                String[] pairs = _args.split("$");
                for (String pair : pairs) {
                    int epos = pair.indexOf("=");
                    if (epos == -1) {
                        System.err.println("[cve-2022-42889] ignoring invalid agent argument: " + pair);
                        continue;
                    }
                    String k = pair.substring(0, epos);
                    String v = pair.substring(epos + 1, pair.length());
                    if (v.indexOf("=") != -1) {
                        System.err.println("[cve-2022-42889] ignoring invalid agent argument: " + pair);
                        continue;
                    }
                    args.put(k, v);
                }

                String structureMatch = null;
                if (args.containsKey("structureMatch")) {
                    structureMatch = args.get("structureMatch");
                } else {
                    structureMatch = "1";
                }
                if ("0".equals(structureMatch)) {
                    deep_match = false;
                } else if (!"1".equals(structureMatch)) {
                    System.err.println("[cve-2022-42889] ignoring invalid structureMatch argument: " + structureMatch);
                }
            }

            if (deep_match) {
                Cve202242889.hook_deep_match(inst);
            } else {
                Cve202242889.hook(inst);
            }
        } catch (Throwable t) {
            System.err.println("[cve-2022-42889] Exception raised in agent.");
            t.printStackTrace();
        }
    }
}
